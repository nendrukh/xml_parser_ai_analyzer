## XML Parser & AI Analyzer Service

### Что делает сервис?
Получает XML-файл с данными о продажах, обрабатывает его, сохраняет данные в базе и генерирует аналитический отчет с помощью LLM.

### Стек технологий
* asyncio
* FastAPI
* PostgreSQL
* asyncpg
* Adminer
* Celery
* Flower
* Redis
* Docker
* OpenAI API
* Pytest

### Запуск сервиса

* В файле .env указать в переменной OPENAI_API_KEY API ключ от OpenAI API
* Запустить docker compose
```commandline
docker-compose up --build
```
* Запланировать задачу:
```
curl -d '<sales_data date="2024-01-01">
    <products>
        <product>
            <id>1</id>
            <name>Product A</name>
            <quantity>100</quantity>
            <price>1500.00</price>
            <category>Electronics</category>
        </product>
    </products>
</sales_data>' http://localhost:8001/schedule_task
```
В ответ вернется:
```
{"status":"Task scheduled","task_id":"983b2597-f74e-4019-be90-26f7a46ac25f"}
```
* Проверка статуса задачи:
```
curl http://localhost:8001/result/983b2597-f74e-4019-be90-26f7a46ac25f
```
### Мониторинг
* Для мониторинга за базой используется adminer:
```
http://localhost:8080/
```
Сервер: postgres

Имя пользователя: main_user

Пароль: Bht34@nnfES

База данных: some_db

* Для мониторинга за тасками используется Flower:
```
http://localhost:8002/
```

### Документация api

Доступна по ссылке:
```
http://localhost:8001/docs
```
Или:
```
http://localhost:8001/redoc
```

### Тесты

Тесты можно запустить в запущенном контейнере:
```
docker-compose exec web_app python -m pytest
```

### Архитектура

В качесте веб-фреймворка использовался FastAPI.

Использовался планировщик задач Celery в связке с брокером Redis. Celery сам по себе не умеет в асинхронность, поэтому дополнительно используется asgiref.

Асинхронность в обработке задач используется при обращении к базе PostgreSQL через asyncpg.

Для парсинга xml используется стандартная библиотека xml.

Дополнительно для наглядной структуры элементов product в xml используется Pydantic модель.

Pydantic валидирует словарь из xml благодаря библиотеке xmltodict. Pydantic удобен в использовании, а также в случае неверного xml формата явно укажет на ошибку. 

### Пример сгенерированного отчета

Промпт:
```
Проанализируй данные о продажах за 16.11.2024:
1. Общая выручка: 100000
2. Топ-3 товара по продажам: Компьютер, Яблоко, Телефон
3. Распределение по категориям: Электроника, Фрукты, Электроника

Составь краткий аналитический отчет с выводами и рекомендациями.
```

Ответ LLM:
```
Аналитический отчет по продажам за 16.11.2024

Общая выручка
- Выручка составила 100,000, что является ключевым показателем эффективности дня.

Топ-3 товара по продажам
1. **Компьютер** (категория: Электроника)  
2. **Яблоко** (категория: Фрукты)  
3. **Телефон** (категория: Электроника)  

Товары из категории "Электроника" заняли две позиции в топе, что говорит о высокой востребованности этой группы. Присутствие "Яблока" в топ-3 подчеркивает важность категории "Фрукты", несмотря на ее меньший вес в общем объеме продаж.

Распределение по категориям
- Электроника явно доминирует в продажах.  
- Фрукты занимают второстепенную, но значимую роль.  

Выводы
1. Электроника — основной драйвер выручки. Компьютеры и телефоны подтверждают высокий спрос на эту категорию.  
2. Фрукты (например, Яблоки) демонстрируют потенциал в сегменте недорогих товаров, которые могут стимулировать дополнительные продажи.  

Рекомендации
1. Расширить ассортимент электроники, с акцентом на популярные товары, такие как компьютеры и телефоны. Рассмотреть продвижение аксессуаров, совместимых с этими товарами.  
2. Усилить продажи фруктов, предложив скидки на крупные закупки или акции "2 по цене 1". Это может привлечь дополнительных покупателей.  
3. Провести рекламную кампанию для увеличения среднего чека, акцентируя внимание на связке "дорогой товар + дополнительный аксессуар".  

Дополнительный анализ данных о продажах за другие дни поможет подтвердить или скорректировать предложенные рекомендации.
```
